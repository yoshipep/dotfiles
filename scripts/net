#!/bin/bash
# Wrapper script for firewall.sh with simplified commands

# on/off: Enable/disable host network access (web browsing)
# don/doff: Enable/disable Docker network access
# enable/disable: Enable/disable entire firewall (change default policy)
# flush: Flush all iptables chains
# start: Load firewall rules
# status: Show current network status
# config: Edit /etc/network.conf, reload Docker, and optionally apply to firewall
# firewall: Edit /etc/firewall.sh and optionally reload

if [[ "$1" == "on" ]]; then
	ACTION="enable-net"
elif [[ "$1" == "off" ]]; then
	ACTION="disable-net"
elif [[ "$1" == "don" ]]; then
	ACTION="enable-docker-net"
elif [[ "$1" == "doff" ]]; then
	ACTION="disable-docker-net"
elif [[ "$1" == "disable" ]]; then
	ACTION="$1"
elif [[ "$1" == "enable" ]]; then
	ACTION="$1"
elif [[ "$1" == "flush" ]]; then
	ACTION="$1"
elif [[ "$1" == "start" ]]; then
	ACTION="$1"
elif [[ "$1" == "status" ]]; then
	# Display current network status
	host_status="unknown"
	docker_status="unknown"

	if [[ -f /etc/.fw_host_status ]]; then
		host_val=$(cat /etc/.fw_host_status)
		if [[ "$host_val" == "1" ]]; then
			host_status="\033[0;31mON\033[0m"  # Red
		else
			host_status="\033[0;32mOFF\033[0m" # Green
		fi
	fi

	if [[ -f /etc/.fw_docker_status ]]; then
		docker_val=$(cat /etc/.fw_docker_status)
		if [[ "$docker_val" == "1" ]]; then
			docker_status="\033[0;31mON\033[0m"  # Red
		else
			docker_status="\033[0;32mOFF\033[0m" # Green
		fi
	fi

	echo -e "Host network:   $host_status"
	echo -e "Docker network: $docker_status"
	exit 0
elif [[ "$1" == "firewall" ]]; then
	# Edit firewall script directly
	FIREWALL_FILE="/etc/firewall.sh"

	if [[ ! -f "$FIREWALL_FILE" ]]; then
		echo "[!] ERROR: Firewall script not found: $FIREWALL_FILE"
		exit 1
	fi

	# Open in editor (requires sudo)
	sudo ${EDITOR:-/opt/neovim/bin/nvim} "$FIREWALL_FILE"

	echo "[+] Firewall script updated"
	echo ""

	# Ask if user wants to reload firewall
	read -p "Reload firewall now? [Y/n]: " reload_fw
	if [[ "$reload_fw" =~ ^[Nn]$ ]]; then
		echo "[!] Firewall NOT reloaded. Run 'net start' to apply changes manually."
		exit 0
	fi

	# Apply firewall changes
	echo "[+] Reloading firewall..."
	sudo /etc/firewall.sh start 'silent'
	echo "[+] Firewall reloaded successfully!"
	exit 0
elif [[ "$1" == "config" ]]; then
	# Edit system-wide network configuration
	CONFIG_FILE="/etc/network.conf"

	if [[ ! -f "$CONFIG_FILE" ]]; then
		echo "[!] ERROR: Network configuration not found: $CONFIG_FILE"
		exit 1
	fi

	# Open in editor (requires sudo)
	sudo ${EDITOR:-/opt/neovim/bin/nvim} "$CONFIG_FILE"

	echo "[+] Network configuration file updated"
	echo ""

	# Ask if user wants to apply changes
	read -p "Apply changes now? (Docker + Firewall) [Y/n]: " apply_changes
	if [[ "$apply_changes" =~ ^[Nn]$ ]]; then
		echo "[!] Changes NOT applied. Run 'net config' again or 'net start' to apply manually."
		exit 0
	fi

	# Reload Docker containers with new configuration
	if [[ -d "$HOME/dockers" ]]; then
		source "$CONFIG_FILE"
		export DNS_SERVER HOST_IP GATEWAY NETMASK WAN_IFACE

		echo "[+] Restarting Docker containers with new configuration..."
		for docker_dir in "$HOME/dockers/"*/; do
			docker_name=$(basename "$docker_dir")
			if [[ -f "$docker_dir/docker-compose.yml" ]]; then
				echo "    Restarting $docker_name..."
				docker compose -f "$docker_dir/docker-compose.yml" down
				docker compose -f "$docker_dir/docker-compose.yml" up -d
			elif [[ -f "$docker_dir/docker-compose.yaml" ]]; then
				echo "    Restarting $docker_name..."
				docker compose -f "$docker_dir/docker-compose.yaml" down
				docker compose -f "$docker_dir/docker-compose.yaml" up -d
			fi
		done
		echo "[+] Docker containers reloaded"
	fi

	# Apply firewall changes
	echo "[+] Applying firewall configuration..."
	sudo /etc/firewall.sh start 'silent'
	echo "[+] Firewall reloaded with new configuration"
	echo "[+] All changes applied successfully!"
	exit 0
else
	echo "Usage: $0 [on|off|don|doff|disable|enable|flush|start|status|config|firewall]" 1>&2;
	echo "" 1>&2;
	echo "Commands:" 1>&2;
	echo "  on       - Enable host network access" 1>&2;
	echo "  off      - Disable host network access" 1>&2;
	echo "  don      - Enable Docker network access" 1>&2;
	echo "  doff     - Disable Docker network access" 1>&2;
	echo "  enable   - Enable firewall (default DROP policy)" 1>&2;
	echo "  disable  - Disable firewall (default ACCEPT policy)" 1>&2;
	echo "  flush    - Flush all iptables rules" 1>&2;
	echo "  start    - Load/restart firewall rules" 1>&2;
	echo "  status   - Show current network status" 1>&2;
	echo "  config   - Edit network config, reload Docker, and optionally apply to firewall" 1>&2;
	echo "  firewall - Edit firewall script and optionally reload" 1>&2;
	exit 1
fi

sudo /etc/firewall.sh "${ACTION}" 'silent'
